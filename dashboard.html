<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Livaura Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4A90E2; --sidebar-bg: #2c3e50; --main-bg: #f4f7f6; --card-bg: #ffffff; --text-color: #34495e; --border-color: #e8e8e8; --font-size-base: 14px; --danger-color: #e74c3c; --success-color: #2ecc71;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--main-bg); margin: 0; font-size: var(--font-size-base); color: var(--text-color); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .top-nav { display: flex; justify-content: space-between; align-items: center; background-color: var(--card-bg); padding: 0 1.5rem; height: 60px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .app-container { display: flex; flex-grow: 1; overflow: hidden; }
        .sidebar { width: 220px; background-color: var(--sidebar-bg); padding: 1rem; display: flex; flex-direction: column; flex-shrink: 0; }
        .nav-list { list-style: none; padding: 0; margin: 0; }
        .nav-item a { display: flex; align-items: center; padding: 0.8rem; text-decoration: none; border-radius: 6px; margin-bottom: 0.25rem; color: #bdc3c7; font-weight: 500; }
        .logout-btn { margin-top: auto; border-top: 1px solid #34495e; padding-top: 0.5rem; }
        .content-wrapper { flex-grow: 1; padding: 1.5rem; overflow-y: auto; }
        .sub-nav { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; }
        .sub-nav button { background: none; border: none; padding: 0.8rem 1.2rem; cursor: pointer; font-family: 'Poppins', sans-serif; font-size: 0.95rem; font-weight: 500; color: #7f8c8d; border-bottom: 3px solid transparent; margin-bottom: -1px; }
        .sub-nav button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .card { background-color: var(--card-bg); padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 1.5rem; }
        h2 { margin-top: 0; font-size: 1.2rem; padding-bottom: 0.8rem; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem; }
        input[type="text"], input[type="number"], textarea { width: 100%; padding: 10px; margin-bottom: 0.8rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; font-family: 'Poppins', sans-serif; }
        button, .button { background-color: var(--primary-color); color: #fff; border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 500; }
        .button.secondary { background-color: #95a5a6; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .hidden { display: none; }
        /* --- Notification CSS (to be added to the style block of all room HTML files) --- */
/* ADDED: Notification Bar Styles */
        #notificationBar {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 300px;
        }
        .notification {
            background-color: var(--card-bg);
            color: var(--text-color);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 5px solid var(--primary-color);
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        .notification-header {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        .notification-body {
            font-size: 0.85rem;
        }
        #requestModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        #requestModal.is-visible { display: flex; }
        .error-message { color: var(--danger-color); font-size: 0.8rem; margin-top: -0.5rem; margin-bottom: 0.5rem; min-height: 1.2em; }
    </style>
</head>
<body>
    <header class="top-nav">
        <div class="brand">Livaura</div>
        <div class="user-profile"><span id="userName"></span></div>
    </header>
    <div class="app-container">
        <aside class="sidebar">
            <ul class="nav-list">
                <li class="nav-item"><a href="#" class="nav-link active"><span>Dashboard</span></a></li>
            </ul>
            <div class="logout-btn"><button id="logoutBtn" style="background:none; border:none; color:inherit; padding:0; width:100%; text-align:left;">Logout</button></div>
        </aside>
        <main class="content-wrapper">
            <nav class="sub-nav">
                <button class="sub-nav-btn active" data-target="createRoomPane">Create Room</button>
                <button class="sub-nav-btn" data-target="joinRoomPane">Join with Code</button>
                <button class="sub-nav-btn" data-target="findRoomPane">Find Public Rooms</button>
                <button class="sub-nav-btn" data-target="outgoingRequestsPane">Requests</button>
            </nav>
            <div id="createRoomPane" class="sub-content-pane">
                <div class="card">
                    <h2>Create a New Room</h2>
                    <form id="createRoomForm" class="form-grid" novalidate>
                        <div>
                            <input type="text" id="roomNameInput" placeholder="Room Name" required>
                            <input type="number" id="roomMaxMembersInput" placeholder="Max number of members (min 2)" required min="2">
                            <input type="text" id="roomLocationInput" placeholder="Location (e.g., Vellore)" required>
                        </div>
                        <div>
                            <input type="text" id="roomContactInput" placeholder="Contact Email or Phone" required>
                            <div id="contactError" class="error-message"></div>
                            <textarea id="roomDescriptionInput" placeholder="Short description..." rows="4"></textarea>
                            <label><input type="checkbox" id="roomIsPublicSwitch"> Make room public</label>
                        </div>
                    </form>
                    <button type="submit" form="createRoomForm">Create Room</button>
                </div>
            </div>
            <div id="joinRoomPane" class="sub-content-pane hidden">
                <div class="card">
                    <h2>Request to Join with Code</h2>
                    <form id="joinRoomForm">
                        <input type="text" id="joinCodeInput" placeholder="Enter 6-Character Join Code" required>
                        <button type="submit">Send Request</button>
                    </form>
                </div>
            </div>
            <div id="findRoomPane" class="sub-content-pane hidden">
                <div class="card">
                    <h2>Find a Public Room</h2>
                    <form id="searchPublicRoomsForm">
                        <input type="text" id="searchLocationInput" placeholder="Enter a city or leave blank for all">
                        <button type="submit">Search</button>
                    </form>
                    <div id="publicRoomsResults" style="margin-top: 1.5rem;"></div>
                </div>
            </div>
            <div id="outgoingRequestsPane" class="sub-content-pane hidden">
                <div class="card">
                    <h2>Outgoing Requests</h2>
                    <div id="outgoingRequestsList"></div>
                </div>
            </div>
        </main>
    </div>
    <div id="requestModal">
        <div class="card" style="width: 90%; max-width: 450px;">
            <h2>Request to Join <span id="modalRoomName"></span></h2>
            <form id="sendRequestForm">
                <input type="hidden" id="modalRoomId">
                <textarea id="modalMessage" rows="4" placeholder="Write a brief message to the owner..." required></textarea>
                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem;">
                    <button type="button" id="closeModalBtn" class="button secondary">Cancel</button>
                    <button type="submit">Send Request</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('livaura_token');
        const user = JSON.parse(localStorage.getItem('livaura_user'));
        const API_BASE_URL = 'http://localhost:5001';

        async function initializeDashboard() {
            if (!token || !user) { window.location.href = 'index.html'; return; }
            document.getElementById('userName').textContent = user.name;
            try {
                const response = await fetch(`${API_BASE_URL}/api/rooms`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error('Could not verify room status.');
                const room = await response.json();
                if (room) {
                    window.location.href = 'room.html';
                }
            } catch (err) {
                console.error("Failed to check room status:", err);
            }
        }

        document.getElementById('createRoomForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const contactInput = document.getElementById('roomContactInput');
        const contactError = document.getElementById('contactError');
        const contactValue = contactInput.value.trim();
        const emailPattern = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/;
        const phonePattern = /^(?:\+91|0)?[6-9]\d{9}$/;
        let isContactValid = emailPattern.test(contactValue) || phonePattern.test(contactValue);
        
        contactError.textContent = '';
        if (!isContactValid) {
            contactError.textContent = 'Please enter a valid email or 10-digit Indian mobile number.';
            return;
        }

        const maxMembers = parseInt(document.getElementById('roomMaxMembersInput').value, 10);
        if(isNaN(maxMembers) || maxMembers < 2) {
            alert('Maximum members must be at least 2.');
            return;
        }

        const payload = {
            name: document.getElementById('roomNameInput').value,
            maxMembers: maxMembers,
            location: document.getElementById('roomLocationInput').value,
            contact: contactValue,
            description: document.getElementById('roomDescriptionInput').value,
            isPublic: document.getElementById('roomIsPublicSwitch').checked
        };

        if (!payload.name || !payload.location) {
            alert('Please fill out all required fields.');
            return;
        }
        
        try {
            const response = await fetch(`${API_BASE_URL}/api/rooms/create`, {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(payload)
            });
            if (response.ok) {
                window.location.href = 'room.html';
            } else {
                const errorData = await response.json();
                alert(`Create room failed: ${errorData.message}`);
            }
        } catch (err) {
            alert(`Error: ${err.message}`);
        }
    });

        document.getElementById('joinRoomForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const joinCode = document.getElementById('joinCodeInput').value;
            try {
                // Modified to send a join request instead of directly joining
                const response = await fetch(`${API_BASE_URL}/api/requests/send-by-code`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ joinCode, message: "Request to join with code." })
                });
                if (response.ok) {
                    alert('Request sent successfully!');
                } else {
                    const errorData = await response.json();
                    alert(`Request failed: ${errorData.message}`);
                }
            } catch (err) {
                alert(`Error: ${err.message}`);
            }
        });

        async function findPublicRooms(location = '') {
            try {
                const response = await fetch(`${API_BASE_URL}/api/rooms/public?location=${encodeURIComponent(location)}`);
        
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to fetch rooms.');
                }

                const rooms = await response.json();
                const resultsDiv = document.getElementById('publicRoomsResults');
                if (rooms.length === 0) { 
                    resultsDiv.innerHTML = '<p>No public rooms found.</p>'; 
                    return; 
                }
                resultsDiv.innerHTML = rooms.map(room => `
                    <div class="card" style="padding:1rem; margin-top:1rem;">
                        <h3>${room.name} (${room.location})</h3>
                        <p>${room.description}</p>
                        <p><strong>Members:</strong> ${room.memberCount}/${room.maxMembers}</p>
                        <button class="button request-join-btn" data-room='${JSON.stringify(room)}'>Request to Join</button>
                    </div>`).join('');
            } catch (err) {
                alert(`Error: ${err.message}`);
            }
        }

        async function fetchOutgoingRequests() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/requests/outgoing`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const requests = await response.json();
                const listDiv = document.getElementById('outgoingRequestsList');
                if (requests.length === 0) {
                    listDiv.innerHTML = '<p>No outgoing join requests.</p>';
                } else {
                    listDiv.innerHTML = requests.map(req => `
                        <div class="card" style="padding:1rem; margin-top:1rem;">
                            <h3>Request for room: ${req.room.name}</h3>
                            <p><strong>Status:</strong> <span style="font-weight:bold; color:${req.status === 'accepted' ? 'green' : req.status === 'declined' ? 'red' : 'orange'};">${req.status.toUpperCase()}</span></p>
                            <p><strong>Message:</strong> ${req.message || 'No message provided'}</p>
                        </div>
                    `).join('');
                }
            } catch (err) {
                alert(`Error: ${err.message}`);
            }
        }

        document.getElementById('searchPublicRoomsForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const location = document.getElementById('searchLocationInput').value;
            findPublicRooms(location);
        });
        
        document.getElementById('publicRoomsResults').addEventListener('click', e => {
            if (e.target && e.target.classList.contains('request-join-btn')) {
                const room = JSON.parse(e.target.dataset.room);
                document.getElementById('modalRoomId').value = room._id;
                document.getElementById('modalRoomName').textContent = room.name;
                document.getElementById('requestModal').classList.add('is-visible');
            }
        });

        document.getElementById('closeModalBtn').addEventListener('click', () => {
            document.getElementById('requestModal').classList.remove('is-visible');
        });

        document.getElementById('sendRequestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const roomId = document.getElementById('modalRoomId').value;
            const message = document.getElementById('modalMessage').value;
            try {
                const response = await fetch(`${API_BASE_URL}/api/requests/send`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ roomId, message })
                });
                if (response.ok) { 
                    alert('Request sent!'); 
                } else {
                    const errorData = await response.json();
                    alert(`Request failed: ${errorData.message}`);
                }
            } catch (err) {
                alert(`Error: ${err.message}`);
            }
            document.getElementById('requestModal').classList.remove('is-visible');
            e.target.reset();
        });
        
        document.querySelectorAll('.sub-nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.sub-nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const targetId = btn.getAttribute('data-target');
                document.querySelectorAll('.sub-content-pane').forEach(pane => { 
                    pane.id === targetId ? pane.classList.remove('hidden') : pane.classList.add('hidden'); 
                });
                if (targetId === 'findRoomPane') {
                    findPublicRooms();
                } else if (targetId === 'outgoingRequestsPane') {
                    fetchOutgoingRequests();
                }
            });
        });

        document.getElementById('logoutBtn').addEventListener('click', () => { 
            localStorage.clear(); 
            window.location.href = 'index.html'; 
        });

        initializeDashboard();
    </script>
</body>
</html>